<html>
<head>
</head>
<body>
  <p>device motion tests below:</p>
  <button id="motion-button">request motion permission</button>
  <div id="motionStatusConsole">
    <p>motion status console:</p>
  </div>
  <hr>
  <p>compressor tests below</p>
  <button id="load-button">load</button>
  <button id="start-button">start</button>
  <button id="stop-button">stop</button>
  <p id="meterLabel">meter</p>
  <p id="peakLabel">peak</p>
  <p id="masterMeterLabel">master meter</p>
  <p id="masterPeakLabel">master peak</p>
  <p id="gainReductionlabel">gain reduction</p>

  <script src="tonemotion-shared/js/tone-builds/build-v14-7-77/Tone.js"></script>

  <script>

  /*****
  device motion access tests are below
  *****/

  let testStatus = 'unknown';

  document.querySelector('#motion-button').addEventListener('click', () => {

    postMessage('motion button was clicked');

    if (typeof DeviceMotionEvent !== 'undefined' &&
    typeof DeviceMotionEvent.requestPermission === 'function') {
      DeviceMotionEvent.requestPermission()
      .then(permissionState => {

        postMessage('about to throw error');
        throw Error('bar');

        if (permissionState === 'granted') {
          postMessage('permission granted')
          window.addEventListener('devicemotion', () => {});
        } else {
          // user has not give permission for motion.
          postMessage('permission for motion data access was denied');
        }
      })
      .catch(err => {
        testStatus = 'error';
        postMessage('error');
        console.error('error: ', err);
      });
    } else {
      // handle regular non iOS 13+ devices
      postMessage('DeviceMotionEvent.requestPermission is not a function in this browser');
    }
  });

  const motionStatusConsole = document.querySelector('#motionStatusConsole');
  function postMessage(message) {
    let logMessage = document.createElement('p');
    logMessage.innerHTML = message;
    motionStatusConsole.appendChild(logMessage);
  }

  /*****
  Tone.js compressor tests are below
  *****/
  document.querySelector('#load-button').addEventListener('click', async () => {
    await Tone.start();
    console.log('audio is ready');
    Tone.loaded().then( () => {
      console.log('buffers are loaded');
    });
  });

  const player = new Tone.Player({
    url: "tonemotion-shared/audio/misc/test-square.mp3",
    loop: true,
  });

  const comp = new Tone.Compressor(0, 1).toDestination();

  const meter = new Tone.Meter();
  const masterMeter = new Tone.Meter();
  const meterLabel = document.querySelector('#meterLabel');
  const peakLabel = document.querySelector('#peakLabel');
  const masterMeterLabel = document.querySelector('#masterMeterLabel');
  const masterPeakLabel = document.querySelector('#masterPeakLabel');
  const gainReductionLabel = document.querySelector('#gainReductionLabel');

  player.chain(meter, comp);
  Tone.Destination.connect(masterMeter);

  document.querySelector('#start-button').addEventListener('click', () => {
    player.start();
    setInterval(updateMeter, 20);
  });

  var meterLevel, masterMeterLevel;
  var peakLevel = masterPeakLevel = Number.NEGATIVE_INFINITY;
  function updateMeter() {
    meterLevel = meter.getValue();
    meterLabel.innerText = meterLevel;
    if (meterLevel > peakLevel) {
      peakLevel = meterLevel;
      peakLabel.innerText = peakLevel;
    }
    masterMeterLevel = masterMeter.getValue();
    masterMeterLabel.innerText = masterMeterLevel;
    if (masterMeterLevel > masterPeakLevel) {
      masterPeakLevel = masterMeterLevel;
      masterPeakLabel.innerText = masterPeakLevel;
    }
    gainReductionLabel.innerText = comp.reduction;
  }

  document.querySelector('#stop-button').addEventListener('click', () => {
    player.stop();
  });

  </script>
</body>
</html>
