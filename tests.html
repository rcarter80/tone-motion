<html>
<head>
</head>
<body>
  <p>test.</p>
  <button id="load-button">load</button>
  <button id="start-button">start</button>
  <button id="stop-button">stop</button>
  <p id="meterLabel">meter</p>
  <p id="peakLabel">peak</p>

  <script src="build-v14-7-77/Tone.js"></script>

  <script>
  document.querySelector('#load-button')?.addEventListener('click', async () => {
    await Tone.start();
    console.log('audio is ready');
    Tone.loaded().then( () => {
      console.log('buffers are loaded');
    });
  });

  const player = new Tone.Player({
    url: "test-square.mp3",
    loop: true,
  }).toDestination();

// TODO: replace with Tone.Limiter
  const comp = new Tone.Compressor(-0.1, 5);
  const distortion = new Tone.Distortion(0.5);
  const meter = new Tone.Meter();
  const meterLabel = document.querySelector('#meterLabel');
  const peakLabel = document.querySelector('#peakLabel');

  Tone.Destination.chain(comp, meter);

  document.querySelector('#start-button').addEventListener('click', () => {
    player.start();
    setInterval(updateMeter, 20);
  });

  var meterLevel;
  var peakLevel = Number.NEGATIVE_INFINITY;
  function updateMeter() {
    meterLevel = meter.getValue();
    meterLabel.innerText = meter.getValue();
    if (meterLevel > peakLevel) {
      peakLevel = meterLevel;
      peakLabel.innerText = peakLevel;
    }
  }

  document.querySelector('#stop-button').addEventListener('click', () => {
    player.stop();
  });

  </script>
</body>
</html>
